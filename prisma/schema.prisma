datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  MEMBER
}

enum CommandStatus {
  ALLOWED
  BLOCKED
  FAILED
}

model User {
  id       Int     @id @default(autoincrement())
  email    String  @unique
  password String? // not required as of now since we use API keys, hence optional
  name     String?
  role     Role    @default(MEMBER)
  credits  Int     @default(0)

  apiKeys          ApiKey[]
  commandLogs      CommandLog[]
  approvalRequests ApprovalRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ApiKey {
  id        Int      @id @default(autoincrement())
  keyHash   String   @unique
  prefix    String // first few chars to identify key
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  createdAt DateTime @default(now())
}

enum RuleAction {
  AUTO_ACCEPT
  AUTO_REJECT
  REQUIRE_APPROVAL
}

model CommandRule {
  id        Int        @id @default(autoincrement())
  pattern   String     @unique // regex goes here
  action    RuleAction @default(AUTO_ACCEPT)
  cost      Int        @default(1)
  startTime String? // HH:mm 24-hour format
  endTime   String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model CommandLog {
  id        Int           @id @default(autoincrement())
  command   String
  status    CommandStatus
  output    String?
  cost      Int
  user      User          @relation(fields: [userId], references: [id])
  userId    Int
  timestamp DateTime      @default(now())
}

model ApprovalRequest {
  id        Int            @id @default(autoincrement())
  command   String
  user      User           @relation(fields: [userId], references: [id])
  userId    Int
  status    ApprovalStatus @default(PENDING)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}
